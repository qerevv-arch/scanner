<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–∫–∞–Ω–µ—Ä ¬´—á–∏—Å—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤¬ª ‚Äî —Å –∫–∞–º–µ—Ä–æ–π (v1.3 ‚Äî full)</title>
  <meta name="description" content="–°–∫–∞–Ω–µ—Ä —á–∏—Å—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤: –∫–∞–º–µ—Ä–∞ —Å –∞–≤—Ç–æ-–≤—ã–±–æ—Ä–æ–º –æ—Å–Ω–æ–≤–Ω–æ–π 1√ó, —Ä–∞–º–∫–∞-–Ω–∞–≤–æ–¥–∫–∞, –∑–≤—É–∫/–≤–∏–±—Ä–æ, –≥–ª—É–±–æ–∫–∏–π –ø–æ–∏—Å–∫ (OFF world+he, Open Beauty, Open Products), –æ—Ü–µ–Ω–∫–∞ —á–∏—Å—Ç–æ—Ç—ã, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã." />
  <style>
    :root { --bg:#0f1221; --card:#171a2c; --text:#e7e9ff; --muted:#a8b2d1; --accent:#7aa2ff;
      --good:#30d158; --warn:#ffd60a; --bad:#ff453a; --border:#2a2f4a; --overlay:#0a0d20e0; --green:#2ddb73; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"SF Pro Text",Inter,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:radial-gradient(1200px 800px at 70% -10%,#1f2440 0%,var(--bg) 45%);color:var(--text)}
    header{padding:24px 16px 8px;text-align:center}
    h1{margin:0;font-size:clamp(20px,4vw,28px);letter-spacing:.2px}
    .sub{color:var(--muted);margin-top:6px;font-size:14px}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.03);padding:18px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}.row>*{flex:1 1 220px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"]{width:100%;padding:14px;border:1px solid var(--border);border-radius:14px;background:#0d1020;color:var(--text);outline:none;font-size:16px}
    input[type="text"]::placeholder{color:#7982a7}
    button{appearance:none;border:0;cursor:pointer;padding:14px 16px;border-radius:14px;background:linear-gradient(180deg,#2b57ff,#2147d8);color:#fff;font-weight:600;font-size:16px;box-shadow:0 10px 20px rgba(59,97,255,.3)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .mutebtn{background:#1a1f36;box-shadow:inset 0 0 0 1px var(--border);color:var(--text)}
    .tiny{font-size:12px;padding:10px 12px}
    .note{font-size:12px;color:var(--muted);margin-top:12px}
    .result{padding:8px 0 0}
    .title{font-size:18px;font-weight:700;margin-bottom:6px}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;font-weight:700;background:#10132a;border:1px solid var(--border)}
    .score{font-size:26px;font-weight:800;letter-spacing:.3px}.light{font-size:22px}
    .good{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    ul{margin:8px 0 0 18px;padding:0}li{margin:4px 0}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}@media(min-width:800px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .alt-item{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:#0f1328}
    .alt-top{display:flex;justify-content:space-between;gap:12px;align-items:baseline}
    .footer{text-align:center;color:var(--muted);font-size:12px;padding:20px 0 40px}
    .src{color:var(--accent);text-decoration:none}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0c0f22;color:var(--muted);font-size:12px}
    .camera{display:none;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap;position:relative}
    video{width:100%;max-height:380px;border-radius:14px;border:1px solid var(--border);background:#000}
    .overlay{position:absolute;inset:0;border-radius:14px;pointer-events:none}
    .ov-window{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(88%,520px);height:48%;outline:2px solid var(--green);border-radius:14px;box-shadow:0 0 0 9999px rgba(12,13,26,.6) inset}
    .ov-corners:before,.ov-corners:after{content:"";position:absolute;border:3px solid var(--green);width:30px;height:30px}
    .ov-corners:before{left:calc(50% - min(44%,260px));top:calc(50% - 24%);border-right:none;border-bottom:none;border-radius:10px 0 0 0}
    .ov-corners:after{right:calc(50% - min(44%,260px));bottom:calc(50% - 24%);border-left:none;border-top:none;border-radius:0 0 10px 0}
    .ov-status{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);background:#0b0f20;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:#cbd3ff}
    select{width:100%;padding:10px;border-radius:10px;background:#0d1020;color:var(--text);border:1px solid var(--border)}
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#11152e;color:#fff;border:1px solid var(--border);padding:10px 14px;border-radius:10px;font-size:13px;box-shadow:0 6px 18px rgba(0,0,0,.4);opacity:0;transition:opacity .2s}
    .toast.show{opacity:1}
    .history{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{border:1px solid var(--border);background:#0d1020;color:var(--text);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .ctl{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .range{display:flex;gap:8px;align-items:center}
    input[type="range"]{width:200px}
  </style>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>
  <header>
    <h1>–°–∫–∞–Ω–µ—Ä ¬´—á–∏—Å—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤¬ª ‚Äî v1.3 (full)</h1>
    <div class="sub">OFF world + he ‚Ä¢ Open Beauty Facts ‚Ä¢ Open Products Facts ‚Ä¢ –†—É—Å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Ä¢ –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <label>–®—Ç—Ä–∏—Ö-–∫–æ–¥ (EAN/UPC)</label>
          <input id="barcode" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 5449000000996" inputmode="numeric" />
          <div class="history" id="hist"></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
          <button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          <button id="demoBtn" class="mutebtn" title="–î–µ–º–æ-–∫–æ–¥ Coca-Cola">–î–µ–º–æ</button>
          <button id="camBtn" class="mutebtn" title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä–æ–π">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä–æ–π</button>
          <button id="stopBtn" class="mutebtn tiny" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É" disabled>–°—Ç–æ–ø</button>
        </div>
      </div>
      <div class="camera" id="camWrap">
        <div style="flex:2 1 260px;position:relative">
          <video id="preview" muted playsinline></video>
          <div class="overlay">
            <div class="ov-window ov-corners"></div>
            <div id="ovStatus" class="ov-status">–ì–æ—Ç–æ–≤–æ –∫ —Å–∫–∞–Ω—É‚Ä¶</div>
          </div>
        </div>
        <div style="flex:1 1 260px">
          <label>–ö–∞–º–µ—Ä–∞</label>
          <select id="cameraSelect"></select>
          <div class="ctl" style="margin-top:10px">
            <button id="torchBtn" class="mutebtn tiny" disabled>–§–æ–Ω–∞—Ä–∏–∫</button>
            <button id="focusBtn" class="mutebtn tiny" disabled>–ê–≤—Ç–æ—Ñ–æ–∫—É—Å</button>
            <div class="range"><span>–ó—É–º √ó<span id="zoomVal">1.0</span></span><input id="zoom" type="range" min="1" max="1" step="0.01" value="1" disabled></div>
            <button id="soundBtn" class="mutebtn tiny">–ó–≤—É–∫: –≤–∫–ª</button>
          </div>
          <div class="note" id="camName"></div>
        </div>
      </div>
      <div class="note">
        –ù–∞–≤–µ–¥–∏ –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å—á–∏—Ç—ã–≤–∞–Ω–∏–∏ ‚Äî <b>—â—ë–ª–∫</b> + <b>–≤–∏–±—Ä–æ</b>. –ù–∞ iPhone –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É <b>1√ó</b>.
      </div>
    </div>

    <div id="out" class="result"></div>

    <div class="footer">
      –ê—Ç—Ä–∏–±—É—Ü–∏—è: <a class="src" href="https://openfoodfacts.org" target="_blank" rel="noopener">Open Food Facts</a> / <a class="src" href="https://openbeautyfacts.org" target="_blank" rel="noopener">Open Beauty Facts</a> / <a class="src" href="https://world.openproductsfacts.org" target="_blank" rel="noopener">Open Products Facts</a>.
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
const API_WORLD = 'https://world.openfoodfacts.org/api/v2/product/{barcode}.json';
const API_HE    = 'https://he.openfoodfacts.org/api/v2/product/{barcode}.json';
const API_BEAUTY= 'https://world.openbeautyfacts.org/api/v2/product/{barcode}.json';
const API_PROD  = 'https://world.openproductsfacts.org/api/v2/product/{barcode}.json';
const SEARCH_WORLD = 'https://world.openfoodfacts.org/api/v2/search';
const SEARCH_HE    = 'https://he.openfoodfacts.org/api/v2/search';
const SEARCH_BEAUTY= 'https://world.openbeautyfacts.org/api/v2/search';
const SEARCH_PROD  = 'https://world.openproductsfacts.org/api/v2/search';

const $ = (sel) => document.querySelector(sel);
function listify(x){ if(x==null) return []; return Array.isArray(x) ? x : [x]; }
function getFloat(v){ const f = parseFloat(v); return Number.isFinite(f) ? f : null; }
function esc(s){ return String(s).replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])); }
function toast(msg, ms=1600){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms); }

// EAN-13
function isValidEAN13(code){
  if(!/^[0-9]{13}$/.test(code)) return false;
  const digits = code.split('').map(d=>parseInt(d,10));
  const check = digits.pop();
  const sum = digits.reduce((acc,d,i)=> acc + d * (i%2===0 ? 1 : 3), 0);
  const calc = (10 - (sum % 10)) % 10;
  return calc === check;
}

// AUDIO (beep) + vibrate
let ac = null; let soundOn = true;
function initAudio(){ try{ ac = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ ac=null; } }
function beep(freq=880, dur=120){
  if(!ac || !soundOn) return;
  try{
    const t0 = ac.currentTime;
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = 'triangle'; o.frequency.value = freq;
    g.gain.setValueAtTime(0.0001, t0);
    o.connect(g); g.connect(ac.destination);
    g.gain.exponentialRampToValueAtTime(0.12, t0 + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + (dur/1000));
    o.start(t0); o.stop(t0 + (dur/1000) + 0.02);
  }catch(e){/*ignore*/}
}
function vibrate(ms=30){ try{ navigator.vibrate && navigator.vibrate(ms); }catch(e){} }

// SCORE
function scoreProduct(p){
  let reasons = [];
  let score = 50.0;
  const labels = listify(p.labels_tags).concat(listify(p.labels_old));
  const isOrganic = labels.map(x=>String(x).toLowerCase()).some(tag => tag.includes('organic') || tag.includes('bio') || tag.includes('kosher'));
  if(isOrganic){ score += 10; reasons.push('–û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π/–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç (–ª–µ–π–±–ª—ã/—Ç–µ–≥–∏)'); }
  let additives_n = getFloat(p.additives_n);
  if(additives_n==null){ additives_n = listify(p.additives_tags).length; }
  if(additives_n!=null){
    if(additives_n===0){ score+=12; reasons.push('–ë–µ–∑ –¥–æ–±–∞–≤–æ–∫ (E-—á–∏—Å–µ–ª)'); }
    else if(additives_n<=2){ score+=4; reasons.push(`–ù–µ–º–Ω–æ–≥–æ –¥–æ–±–∞–≤–æ–∫: ${additives_n}`); }
    else if(additives_n<=5){ score-=6; reasons.push(`–ú–Ω–æ–≥–æ –¥–æ–±–∞–≤–æ–∫: ${additives_n}`); }
    else { score-=15; reasons.push(`–û—á–µ–Ω—å –º–Ω–æ–≥–æ –¥–æ–±–∞–≤–æ–∫: ${additives_n}`); }
  }
  let allergens = listify(p.allergens_tags).concat(listify(p.traces_tags)).map(a=>String(a).replace('en:','').replace('ru:','').toLowerCase());
  allergens = Array.from(new Set(allergens)).filter(Boolean);
  if(allergens.length){ score -= 6; reasons.push('–ï—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã/—Å–ª–µ–¥—ã: ' + allergens.sort().slice(0,6).join(', ')); }
  let nova = p.nova_group || p.nova_groups;
  nova = parseInt(nova); if(!Number.isFinite(nova)) nova = null;
  if(nova){
    if(nova===1){ score+=10; reasons.push('NOVA 1 ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç'); }
    else if(nova===2){ score+=5; reasons.push('NOVA 2 ‚Äî –±–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞'); }
    else if(nova===3){ score-=5; reasons.push('NOVA 3 ‚Äî –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç'); }
    else if(nova>=4){ score-=12; reasons.push('NOVA 4 ‚Äî —É–ª—å—Ç—Ä–∞–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç'); }
  }
  const n = p.nutriments || {};
  const sugar = getFloat(n['sugars_100g']);
  const salt = getFloat(n['salt_100g']);
  const satfat = getFloat(n['saturated-fat_100g']) ?? getFloat(n['saturated_fat_100g']);
  if(sugar!=null){
    if(sugar<=2.5){ score+=6; reasons.push(`–ù–∏–∑–∫–∏–π —Å–∞—Ö–∞—Ä: ${sugar} –≥/100–≥`); }
    else if(sugar<=5){ score+=2; reasons.push(`–£–º–µ—Ä–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä: ${sugar} –≥/100–≥`); }
    else if(sugar<=10){ score-=4; reasons.push(`–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä: ${sugar} –≥/100–≥`); }
    else { score-=10; reasons.push(`–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π —Å–∞—Ö–∞—Ä: ${sugar} –≥/100–≥`); }
  }
  if(salt!=null){
    if(salt<=0.3){ score+=4; reasons.push(`–ù–∏–∑–∫–∞—è —Å–æ–ª—å: ${salt} –≥/100–≥`); }
    else if(salt<=1.2){ score+=1; reasons.push(`–£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–æ–ª—å: ${salt} –≥/100–≥`); }
    else if(salt<=2){ score-=4; reasons.push(`–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —Å–æ–ª—å: ${salt} –≥/100–≥`); }
    else { score-=8; reasons.push(`–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è —Å–æ–ª—å: ${salt} –≥/100–≥`); }
  }
  if(satfat!=null){
    if(satfat<=1.5){ score+=3; reasons.push(`–ù–∏–∑–∫–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –∂–∏—Ä—ã: ${satfat} –≥/100–≥`); }
    else if(satfat<=5){ reasons.push(`–£–º–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –∂–∏—Ä—ã: ${satfat} –≥/100–≥`); }
    else { score-=6; reasons.push(`–í—ã—Å–æ–∫–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –∂–∏—Ä—ã: ${satfat} –≥/100–≥`); }
  }
  const ingr = String(p.ingredients_text_ru || p.ingredients_text || p.ingredients_text_he || '').toLowerCase();
  if(ingr.includes('–ø–∞–ª—å–º–æ–≤') || ingr.includes('palm oil') || ingr.includes('–º–∞—Å–ª–æ –ø–∞–ª—å–º–æ–≤') || ingr.includes('◊©◊û◊ü ◊ì◊ß◊ú')){
    score -= 8; reasons.push('–°–æ–¥–µ—Ä–∂–∏—Ç –ø–∞–ª—å–º–æ–≤–æ–µ –º–∞—Å–ª–æ');
  }
  let ingN = p.ingredients_n;
  if(ingN==null && Array.isArray(p.ingredients)) ingN = p.ingredients.length;
  ingN = parseInt(ingN);
  if(Number.isFinite(ingN)){
    if(ingN<=5){ score+=5; reasons.push(`–ö–æ—Ä–æ—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: ${ingN}`); }
    else if(ingN<=10){ reasons.push(`–°—Ä–µ–¥–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: ${ingN}`); }
    else { score-=4; reasons.push(`–î–ª–∏–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: ${ingN}`); }
  }
  score = Math.round(Math.max(0, Math.min(100, score)));
  const light = score>=70 ? 'üü¢ –∑–µ–ª—ë–Ω—ã–π' : (score>=40 ? 'üü° –∂—ë–ª—Ç—ã–π' : 'üî¥ –∫—Ä–∞—Å–Ω—ã–π');
  reasons.unshift(`–°–≤–µ—Ç–æ—Ñ–æ—Ä: ${light}`);
  return { score, reasons, light };
}

function formatTitle(p){
  const brand = String(p.brands||'').split(',')[0].trim();
  let name = p.product_name_ru || p.product_name_he || p.product_name || p.generic_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  name = String(name);
  if(brand && !name.toLowerCase().includes(brand.toLowerCase())){
    return `${brand} ‚Äî ${name}`;
  }
  return name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
}
function isIL(p){
  const code = String(p.code||'');
  if(code.startsWith('729')) return true;
  const ct = listify(p.countries_tags).map(x=>String(x).toLowerCase());
  return ct.some(c=>c.includes('israel'));
}

async function fetchJSON(url, params){
  if(params){
    const usp = new URLSearchParams(params);
    url += '?' + usp.toString();
  }
  const res = await fetch(url);
  if(!res.ok){
    const err = new Error('HTTP '+res.status);
    err.status = res.status;
    throw err;
  }
  return await res.json();
}

function pickBest(products){
  let best=null, bestScore=-1;
  for(const p of (products||[])){
    let s=0;
    if(p.product_name || p.product_name_he || p.product_name_ru) s+=4;
    if(p.brands) s+=2;
    if(p.ingredients_text || p.ingredients_text_he || p.ingredients) s+=3;
    if(p.nutriments) s+=3;
    if(p.nova_group || p.nova_groups) s+=1;
    if(p.code) s+=1;
    if(typeof p.completeness_score === 'number') s += Math.min(3, p.completeness_score);
    if(s>bestScore){ best=p; bestScore=s; }
  }
  return best;
}

async function deepFetch(barcode){
  const endpoints = [
    {type:'product', name:'OFF world', url: API_WORLD.replace('{barcode}', encodeURIComponent(barcode))},
    {type:'product', name:'OFF he',    url: API_HE.replace('{barcode}', encodeURIComponent(barcode))},
    {type:'product', name:'Beauty',    url: API_BEAUTY.replace('{barcode}', encodeURIComponent(barcode))},
    {type:'product', name:'Products',  url: API_PROD.replace('{barcode}', encodeURIComponent(barcode))},
  ];
  const searches = [
    {name:'OFF world search',  url: SEARCH_WORLD,  params: { code: barcode, lc:'he', cc:'il', page_size: 20, json:1 }},
    {name:'OFF he search',     url: SEARCH_HE,     params: { code: barcode, lc:'he', cc:'il', page_size: 20, json:1 }},
    {name:'Beauty search',     url: SEARCH_BEAUTY, params: { code: barcode, lc:'he', cc:'il', page_size: 20, json:1 }},
    {name:'Products search',   url: SEARCH_PROD,   params: { code: barcode, lc:'he', cc:'il', page_size: 20, json:1 }},
  ];
  const tried = [];
  for(const ep of endpoints){
    try{
      const data = await fetchJSON(ep.url);
      tried.push(ep.name);
      if(data && (data.status===1 || data.product)){
        return { product: data.product, source: ep.name, tried };
      }
    }catch(e){ tried.push(ep.name + ' (err ' + (e.status||'') + ')'); }
  }
  for(const s of searches){
    try{
      const data = await fetchJSON(s.url, s.params);
      tried.push(s.name);
      const prod = pickBest(data && data.products);
      if(prod){ return { product: prod, source: s.name, tried }; }
    }catch(e){ tried.push(s.name + ' (err ' + (e.status||'') + ')'); }
  }
  return { notFound: true, tried };
}

async function searchAlternativesDual(p, minSame, minGlobal, limitEach=5){
  const fields = "product_name,product_name_ru,product_name_he,brands,additives_n,additives_tags,allergens_tags,traces_tags,nutriscore_grade,nutrition_grades,nutriments,nova_group,ingredients,ingredients_n,labels_tags,labels_old,code,categories_tags,countries_tags";
  const categories = listify(p.categories_tags);
  const paramsSame = { fields, page_size: 80, sort_by: "unique_scans_n", json: 1, lc: 'he', cc: 'il' };
  if(categories.length){ paramsSame.categories_tags = categories[0]; }
  else { paramsSame.search_terms = formatTitle(p).split('‚Äî').pop().trim(); }
  const sameData = await fetchJSON(SEARCH_WORLD, paramsSame);
  const sameProducts = sameData.products || [];
  const sameScored = sameProducts.map(x=>({ p:x, ...scoreProduct(x) }));
  sameScored.sort((a,b)=> (b.score + (isIL(b.p)?0.6:0)) - (a.score + (isIL(a.p)?0.6:0)));
  const sameOut = [];
  for(const it of sameScored){
    if(it.score >= minSame && it.p.code !== p.code){
      sameOut.push({score: it.score, p: it.p});
      if(sameOut.length>=limitEach) break;
    }
  }
  const paramsGlobal = { fields, page_size: 120, sort_by: "unique_scans_n", json:1, categories_tags: "en:waters,en:spring-waters,en:mineral-waters" };
  const globalData = await fetchJSON(SEARCH_WORLD, paramsGlobal);
  const globalProducts = globalData.products || [];
  const globalScored = globalProducts.map(x=>({ p:x, ...scoreProduct(x) }));
  globalScored.sort((a,b)=> (b.score + (isIL(b.p)?0.6:0)) - (a.score + (isIL(a.p)?0.6:0)));
  const globalOut = [];
  for(const it of globalScored){
    if(it.score >= minGlobal && it.p.code !== p.code){
      globalOut.push({score: it.score, p: it.p});
      if(globalOut.length>=limitEach) break;
    }
  }
  return { sameOut, globalOut };
}

function badgeClass(light){
  if(light.includes('–∑–µ–ª—ë–Ω—ã–π')) return 'badge good';
  if(light.includes('–∂—ë–ª—Ç—ã–π')) return 'badge warn';
  return 'badge bad';
}
function renderProduct(p, sr, metaSource, triedList){
  const title = formatTitle(p);
  const code = esc(p.code || '');
  const badge = `<span class="${badgeClass(sr.light)}"><span class="light">${esc(sr.light)}</span> <span class="score">${sr.score}/100</span></span>`;
  const tried = triedList && triedList.length ? `<div class="note">–ò—Å—Ç–æ—á–Ω–∏–∫: ${esc(metaSource)} ‚Ä¢ –ü—Ä–æ–±–æ–≤–∞–ª–∏: ${esc(triedList.join(', '))}</div>` : '';
  return `
    <div class="card">
      <div class="title">${esc(title)}</div>
      <div class="code">–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${code}</div>
      <div style="margin-top:10px">${badge}</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <div class="pill">NOVA: ${esc(p.nova_group || p.nova_groups || '‚Äî')}</div>
        <div class="pill">Nutri-Score: ${esc(((p.nutriscore_grade||p.nutrition_grades||'')+'').toUpperCase()||'‚Äî')}</div>
        ${isIL(p)?'<div class="pill">üáÆüá± –ò–∑—Ä–∞–∏–ª—å</div>':''}
      </div>
      ${tried}
      <div style="margin-top:12px">
        <div style="font-weight:700;margin-bottom:6px">–ü—Ä–∏—á–∏–Ω—ã/—Ñ–∞–∫—Ç–æ—Ä—ã:</div>
        <ul>${sr.reasons.map(r=>`<li>${esc(r)}</li>`).join('')}</ul>
      </div>
    </div>
  `;
}
function renderAlts(title, items){
  if(!items || !items.length) return `
    <div class="card">
      <div class="title">${esc(title)}</div>
      <div class="note">–ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>
    </div>`;
  return `
    <div class="card">
      <div class="title">${esc(title)}</div>
      <div class="grid">
        ${items.map(it=>{
          const p = it.p;
          return `<div class="alt-item">
            <div class="alt-top">
              <div style="font-weight:700">${esc(formatTitle(p))}</div>
              <div class="${it.score>=70?'good':(it.score>=40?'warn':'bad')}">${it.score}/100</div>
            </div>
            <div class="code">–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${esc(p.code||'')}</div>
            <div class="note">${isIL(p)?'üáÆüá± –ò–∑—Ä–∞–∏–ª—å':''}</div>
          </div>`;
        }).join('')}
      </div>
    </div>
  `;
}
function setBusy(b){ $('#checkBtn').disabled = b; $('#demoBtn').disabled = b; $('#camBtn').disabled = b; $('#stopBtn').disabled = !b; }
function setOvStatus(m){ const s=$('#ovStatus'); if(s) s.textContent=m; }

// ====== CAMERA ======
let codeReader = null;
let currentDeviceId = null;
let currentTrack = null;
let scanBusy = false;

function labelScore(lbl){
  const s = (lbl||'').toLowerCase();
  let score = 0;
  if(/back|rear|–∑–∞–¥–Ω/.test(s)) score += 3;
  if(/wide|1x|–æ—Å–Ω–æ–≤–Ω|main|—Å—Ç–∞–Ω–¥–∞—Ä/.test(s)) score += 4;
  if(/tele|—Ç–µ–ª–µ|2x|3x|zoom/.test(s)) score -= 4;
  if(/ultra|—É–ª—å—Ç—Ä–∞|0\.5x|0,5x/.test(s)) score -= 2;
  if(/front|–ø–µ—Ä–µ–¥–Ω/.test(s)) score -= 3;
  return score;
}

async function ensurePermissionLabels(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    s.getTracks().forEach(t => t.stop());
  }catch(e){}
}

async function enumerateCameras(){
  await ensurePermissionLabels();
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d => d.kind === 'videoinput')
                      .map(d => ({ deviceId: d.deviceId, label: d.label||'' }));
  cams.sort((a,b) => labelScore(b.label) - labelScore(a.label));
  return cams;
}

async function listCamerasToSelect(cams){
  const sel = $('#cameraSelect');
  sel.innerHTML = '';
  cams.forEach((c, i) => {
    const opt = document.createElement('option');
    opt.value = c.deviceId;
    opt.textContent = c.label || `–ö–∞–º–µ—Ä–∞ ${i+1}`;
    sel.appendChild(opt);
  });
  if(cams.length){
    currentDeviceId = cams[0].deviceId;
    sel.value = currentDeviceId;
    $('#camName').textContent = '–¢–µ–∫—É—â–∞—è: ' + (cams[0].label || '–∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞');
  }
}

async function startCamera(){
  try{
    initAudio();
    setOvStatus('–û—Ç–∫—Ä—ã–≤–∞—é –∫–∞–º–µ—Ä—É‚Ä¶');
    $('#camWrap').style.display = 'flex';
    if(!codeReader){ codeReader = new ZXing.BrowserMultiFormatReader(); }
    const cams = await enumerateCameras();
    if(!cams.length){
      alert('–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤. –†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.');
      $('#camWrap').style.display = 'none';
      return;
    }
    await listCamerasToSelect(cams);

    const video = $('#preview');
    setBusy(true);

    const formats = [
      ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8,
      ZXing.BarcodeFormat.UPC_A, ZXing.BarcodeFormat.UPC_E,
      ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.CODE_39
    ];
    codeReader?.hints?.set?.(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);

    const constraints = { video: { deviceId: { exact: currentDeviceId }, facingMode: 'environment' } };
    setOvStatus('–ù–∞–≤–æ–∂—É —Ñ–æ–∫—É—Å‚Ä¶');
    await codeReader.decodeFromConstraints(constraints, video, (result, err) => {
      if(scanBusy) return;
      if(result){
        const text = String(result.getText()).trim();
        if(text.length===13 && isValidEAN13(text)){
          scanBusy = true;
          $('#barcode').value = text;
          setOvStatus('–ù–∞—à—ë–ª –∫–æ–¥: ' + text);
          beep(920,120); vibrate(40);
          stopCamera();
          run().finally(()=> scanBusy=false);
        }else{
          setOvStatus('–ö–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∫—Ä–∏–≤–æ ‚Äî –ø–æ–¥–µ—Ä–∂–∏ —Ä–æ–≤–Ω–µ–µ');
        }
      }else{
        setOvStatus('–ò—â—É —à—Ç—Ä–∏—Ö-–∫–æ–¥‚Ä¶');
      }
    });

    const stream = video.srcObject;
    currentTrack = stream ? stream.getVideoTracks()[0] : null;
    setupControlsForTrack(currentTrack);

  } catch(e){
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É: ' + (e.message||e) + '\n–ù–∞ HTTPS –¥–æ—Å—Ç—É–ø —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ. –ù–∞ iPhone ‚Äî Safari.');
    $('#camWrap').style.display = 'none';
  } finally {
    setBusy(false);
  }
}

function setupControlsForTrack(track){
  const zoom = $('#zoom'); const zv = $('#zoomVal');
  const torchBtn = $('#torchBtn'); const focusBtn = $('#focusBtn');

  zoom.disabled = torchBtn.disabled = focusBtn.disabled = true;
  if(!track) return;

  const caps = track.getCapabilities ? track.getCapabilities() : {};
  const settings = track.getSettings ? track.getSettings() : {};

  if(caps.zoom){
    zoom.min = caps.zoom.min || 1;
    zoom.max = caps.zoom.max || 1;
    zoom.step = caps.zoom.step || 0.01;
    const cur = settings.zoom || 1;
    zoom.value = cur;
    zv.textContent = Number(cur).toFixed(1);
    zoom.oninput = async (e)=>{
      try{
        const val = parseFloat(e.target.value);
        await track.applyConstraints({ advanced: [{ zoom: val }] });
        zv.textContent = val.toFixed(1);
      }catch(err){}
    };
    zoom.disabled = false;
  }
  if(caps.torch){
    let on = false;
    torchBtn.onclick = async ()=>{
      try{
        on = !on;
        await track.applyConstraints({ advanced: [{ torch: on }] });
        torchBtn.textContent = on ? '–§–æ–Ω–∞—Ä–∏–∫ ‚¨§' : '–§–æ–Ω–∞—Ä–∏–∫';
      }catch(err){ toast('–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —ç—Ç–æ–π –∫–∞–º–µ—Ä–µ'); }
    };
    torchBtn.disabled = false;
  }
  focusBtn.onclick = async ()=>{
    try{
      const s = track.getSettings();
      const cur = s.zoom || 1;
      const bump = Math.min((cur + 0.06), (caps.zoom?.max || (cur+0.06)));
      if(caps.zoom){
        await track.applyConstraints({ advanced: [{ zoom: bump }] });
        await new Promise(r=>setTimeout(r, 130));
        await track.applyConstraints({ advanced: [{ zoom: cur }] });
      } else {
        stopCamera();
        startCamera();
      }
    }catch(err){}
  };
  focusBtn.disabled = false;
}

function stopCamera(){
  try{ codeReader && codeReader.reset(); } catch(e){}
  const video = $('#preview');
  if(video && video.srcObject){
    const tracks = video.srcObject.getTracks();
    tracks.forEach(t => t.stop());
    video.srcObject = null;
  }
  currentTrack = null;
  $('#stopBtn').disabled = true;
  setOvStatus('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
}

$('#cameraSelect').addEventListener('change', async ()=>{
  const sel = $('#cameraSelect');
  $('#camName').textContent = '–ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞: ' + (sel.selectedOptions[0]?.textContent || '–∫–∞–º–µ—Ä–∞');
  currentDeviceId = sel.value;
  stopCamera();
  await startCamera();
});
$('#soundBtn').addEventListener('click', ()=>{
  soundOn = !soundOn;
  $('#soundBtn').textContent = '–ó–≤—É–∫: ' + (soundOn ? '–≤–∫–ª' : '–≤—ã–∫–ª');
});

// ======== APP logic =========
const hist = [];
function pushHistory(code){
  if(hist.includes(code)) return;
  hist.unshift(code);
  if(hist.length>8) hist.pop();
  const box = $('#hist');
  box.innerHTML = hist.map(c=>`<span class="chip" data-code="${esc(c)}">${esc(c)}</span>`).join('');
  box.querySelectorAll('.chip').forEach(ch=> ch.addEventListener('click', ()=>{ $('#barcode').value=ch.dataset.code; run(); }));
}

async function run(){
  const bc = $('#barcode').value.trim();
  if(!/^[0-9]{6,}$/.test(bc)){ alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π —à—Ç—Ä–∏—Ö-–∫–æ–¥ (–º–∏–Ω–∏–º—É–º 6 —Ü–∏—Ñ—Ä)'); return; }
  setBusy(true); $('#out').innerHTML = '';
  try{
    const { product, source, tried, notFound } = await deepFetch(bc);
    if(notFound){
      $('#out').innerHTML = `<div class="card">
        <div class="title">–ö–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –±–∞–∑–∞—Ö</div>
        <div class="note">–ü—Ä–æ–±–æ–≤–∞–ª–∏: ${esc((tried||[]).join(', ')||'-')}.</div>
        <div class="note" style="margin-top:8px">–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –º–µ—Å—Ç–Ω—ã—Ö —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤. –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∂—É –∞–Ω–∞–ª–æ–≥–∏ –ø–æ –±—Ä–µ–Ω–¥—É/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å–æ—Å—Ç–∞–≤ ‚Äî –¥–æ—Å—á–∏—Ç–∞–µ–º –±–∞–ª–ª.</div>
      </div>`;
      pushHistory(bc);
      return;
    }
    const sres = scoreProduct(product||{});
    const head = renderProduct(product, sres, source, tried);
    const minSame = Math.max(60, sres.score);
    let altsHTML = '';
    try{
      const { sameOut, globalOut } = await searchAlternativesDual(product, minSame, 85, 5);
      altsHTML = renderAlts('–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –≤ —Ç–æ–π –∂–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', sameOut) + renderAlts('–ó–¥–æ—Ä–æ–≤–µ–µ –≤ —Ü–µ–ª–æ–º', globalOut);
    }catch(e){ altsHTML = ''; }
    $('#out').innerHTML = head + altsHTML
      + `<div class="note" style="margin-top:12px">–≠—Ç–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞. –î–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º–∏.</div>`;
    pushHistory(bc);
  } catch(e){
    $('#out').innerHTML = `<div class="card"><div class="title">–û—à–∏–±–∫–∞</div><div class="note">${esc(String(e.message||e))}. –ù–∞ HTTPS –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ (Safari/iOS).</div></div>`;
  } finally {
    setBusy(false);
  }
}

$('#checkBtn').addEventListener('click', run);
$('#demoBtn').addEventListener('click', ()=>{ $('#barcode').value='5449000000996'; run(); });
$('#barcode').addEventListener('keydown', (e)=>{ if(e.key==='Enter') run(); });
$('#camBtn').addEventListener('click', startCamera);
$('#stopBtn').addEventListener('click', stopCamera);
</script>
</body>
</html>
