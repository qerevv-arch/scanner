<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–∫–∞–Ω–µ—Ä ¬´—á–∏—Å—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤¬ª ‚Äî v1.4 (data-enabled)</title>
  <meta name="description" content="–°–∫–∞–Ω–µ—Ä —á–∏—Å—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤: –∫–∞–º–µ—Ä–∞, OFF/Beauty/Products, –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤ –∏–∑ data/*.json, —Å–≤–µ—Ç–æ—Ñ–æ—Ä, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã." />
  <style>
    :root { --bg:#0f1221; --card:#171a2c; --text:#e7e9ff; --muted:#a8b2d1; --accent:#7aa2ff;
      --good:#30d158; --warn:#ffd60a; --bad:#ff453a; --border:#2a2f4a; --green:#2ddb73; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Inter,Segoe UI,Roboto,Helvetica,Arial;background:#0c1022;color:var(--text)}
    header{padding:20px 14px;text-align:center;background:linear-gradient(180deg,#1a2140,#0c1022)}
    h1{margin:0;font-size:clamp(18px,4vw,26px)}
    .sub{color:var(--muted);margin-top:6px;font-size:13px}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.03);padding:16px;margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}.row>*{flex:1 1 220px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"]{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#0d1228;color:var(--text);outline:none;font-size:16px}
    button{appearance:none;border:0;cursor:pointer;padding:12px 14px;border-radius:12px;background:linear-gradient(180deg,#2b57ff,#2147d8);color:#fff;font-weight:600;font-size:15px;box-shadow:0 10px 20px rgba(59,97,255,.3)}
    button.mute{background:#1a1f36;box-shadow:inset 0 0 0 1px var(--border);color:var(--text)}
    .tiny{font-size:12px;padding:9px 11px}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .title{font-size:18px;font-weight:800;margin-bottom:6px}
    .code{font-family:ui-monospace,Menlo,monospace;color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:9px 11px;border-radius:999px;font-weight:800;background:#10132a;border:1px solid var(--border)}
    .good{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:10px}
    @media(min-width:820px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .alt{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0f1328}
    .camera{display:none;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap;position:relative}
    video{width:100%;max-height:360px;border-radius:12px;border:1px solid var(--border);background:#000}
    .overlay{position:absolute;inset:0;border-radius:12px;pointer-events:none}
    .ov-window{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(88%,520px);height:46%;outline:2px solid var(--green);border-radius:12px;box-shadow:0 0 0 9999px rgba(12,13,26,.6) inset}
    .ov-status{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);background:#0b0f20;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:#cbd3ff}
    select{width:100%;padding:10px;border-radius:10px;background:#0d1020;color:var(--text);border:1px solid var(--border)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0c0f22;color:var(--muted);font-size:12px}
    .ok{color:#7fffb7}.err{color:#ff8f8f}
    .hist{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{border:1px solid var(--border);background:#0d1020;color:var(--text);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  </style>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>
  <header>
    <h1>–°–∫–∞–Ω–µ—Ä ¬´—á–∏—Å—Ç—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤¬ª ‚Äî v1.4 (data-enabled)</h1>
    <div class="sub">OFF world + he ‚Ä¢ Open Beauty Facts ‚Ä¢ Open Products Facts ‚Ä¢ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤ –∏–∑ <code>data/*.json</code></div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <label>–®—Ç—Ä–∏—Ö-–∫–æ–¥</label>
          <input id="barcode" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 5449000000996" inputmode="numeric" />
          <div class="hist" id="hist"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
          <button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          <button id="demoBtn" class="mute">–î–µ–º–æ</button>
          <button id="camBtn" class="mute">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä–æ–π</button>
          <button id="stopBtn" class="mute tiny" disabled>–°—Ç–æ–ø</button>
        </div>
      </div>
      <div class="camera" id="camWrap">
        <div style="flex:2 1 260px;position:relative">
          <video id="preview" muted playsinline></video>
          <div class="overlay">
            <div class="ov-window"></div>
            <div id="ovStatus" class="ov-status">–ì–æ—Ç–æ–≤–æ –∫ —Å–∫–∞–Ω—É‚Ä¶</div>
          </div>
        </div>
        <div style="flex:1 1 260px">
          <label>–ö–∞–º–µ—Ä–∞</label>
          <select id="cameraSelect"></select>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="torchBtn" class="mute tiny" disabled>–§–æ–Ω–∞—Ä–∏–∫</button>
            <button id="focusBtn" class="mute tiny" disabled>–ê–≤—Ç–æ—Ñ–æ–∫—É—Å</button>
            <button id="soundBtn" class="mute tiny">–ó–≤—É–∫: –≤–∫–ª</button>
          </div>
          <div class="note" id="camName"></div>
        </div>
      </div>
      <div class="note">
        –î–∞–Ω–Ω—ã–µ: <span id="dataStatus" class="err">–Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</span>. –ü–∞–ø–∫–∞ <code>data/</code> –¥–æ–ª–∂–Ω–∞ –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å <code>index.html</code>.
      </div>
    </div>

    <div id="out"></div>

    <div class="card">
      <div class="title">–ê—Ç—Ä–∏–±—É—Ü–∏—è</div>
      <div class="note">
        –ò—Å—Ç–æ—á–Ω–∏–∫–∏: <a href="https://openfoodfacts.org" target="_blank" rel="noopener">Open Food Facts</a>,
        <a href="https://openbeautyfacts.org" target="_blank" rel="noopener">Open Beauty Facts</a>,
        <a href="https://world.openproductsfacts.org" target="_blank" rel="noopener">Open Products Facts</a>.
        –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
      </div>
    </div>
  </div>

<script>
// ====== GLOBAL STATE ======
const $ = sel => document.querySelector(sel);
const DATA = {
  providers: null, additives: null, allergens: null, localRules: null,
  alternativesSeed: null, brandsMap: null, ilPriceFeeds: null
};

function listify(x){ if(!x) return []; return Array.isArray(x) ? x : [x]; }
function esc(s){ return String(s).replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]); }
function isValidEAN13(code){
  if(!/^[0-9]{13}$/.test(code)) return false;
  const d = code.split('').map(n=>+n); const check = d.pop();
  const sum = d.reduce((a,v,i)=> a + v*(i%2?3:1), 0);
  return ((10 - sum%10) % 10) === check;
}

async function loadJSON(path){
  try{
    const r = await fetch(path, { cache: 'no-store' });
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }catch(e){ console.warn('loadJSON failed', path, e); return null; }
}

// –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –ø–∞–ø–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–∞ GitHub Pages
const DATA_BASE = 'https://qerevv-arch.github.io/scanner/data/';

async function loadData(){
  DATA.providers        = await loadJSON(DATA_BASE + 'providers.config.json');
  DATA.additives        = await loadJSON(DATA_BASE + 'additives_ru.json');
  DATA.allergens        = await loadJSON(DATA_BASE + 'allergens_ru.json');
  DATA.localRules       = await loadJSON(DATA_BASE + 'local_rules_il.json');
  DATA.alternativesSeed = await loadJSON(DATA_BASE + 'alternatives_seed.json');
  DATA.brandsMap        = await loadJSON(DATA_BASE + 'brands_map.json');
  DATA.ilPriceFeeds     = await loadJSON(DATA_BASE + 'il_price_feeds_sources.json');

  const ok = DATA.providers && DATA.additives && DATA.allergens && DATA.localRules;
  $('#dataStatus').textContent = ok ? '–∑–∞–≥—Ä—É–∂–µ–Ω—ã' : '—á–∞—Å—Ç–∏—á–Ω–æ';
  $('#dataStatus').className   = ok ? 'ok' : 'err';
  return ok;
}

// ====== PROVIDERS (OFF/Beauty/Products) ======
const API = {
  OFF: (bc) => `https://world.openfoodfacts.org/api/v2/product/${encodeURIComponent(bc)}.json`,
  OFF_HE: (bc) => `https://he.openfoodfacts.org/api/v2/product/${encodeURIComponent(bc)}.json`,
  BEU: (bc) => `https://world.openbeautyfacts.org/api/v2/product/${encodeURIComponent(bc)}.json`,
  PRD: (bc) => `https://world.openproductsfacts.org/api/v2/product/${encodeURIComponent(bc)}.json`,
  SEARCH_OFF: `https://world.openfoodfacts.org/api/v2/search`,
  SEARCH_OFF_HE: `https://he.openfoodfacts.org/api/v2/search`,
  SEARCH_BEU: `https://world.openbeautyfacts.org/api/v2/search`,
  SEARCH_PRD: `https://world.openproductsfacts.org/api/v2/search`
};

async function fetchJSON(url, params){
  const u = new URL(url);
  if(params){ Object.entries(params).forEach(([k,v])=> u.searchParams.set(k,v)); }
  const r = await fetch(u.toString());
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

function pickBest(products){
  let best=null, score=-1;
  for(const p of (products||[])){
    let s=0;
    if(p.product_name || p.product_name_he || p.product_name_ru) s+=4;
    if(p.brands) s+=2;
    if(p.ingredients_text || p.ingredients_text_he || p.ingredients) s+=3;
    if(p.nutriments) s+=3;
    if(p.nova_group || p.nova_groups) s+=1;
    if(p.code) s+=1;
    if(typeof p.completeness_score === 'number') s += Math.min(3, p.completeness_score);
    if(s>score){ score=s; best=p; }
  }
  return best;
}

async function deepFetch(barcode){
  const tried = [];
  // OFF world + he
  try{ const d=await fetchJSON(API.OFF(barcode)); tried.push('OFF world');
       if(d && (d.status===1 || d.product)) return {product:d.product, source:'OFF world', tried}; }catch(e){ tried.push('OFF world(err)'); }
  try{ const d=await fetchJSON(API.OFF_HE(barcode)); tried.push('OFF he');
       if(d && (d.status===1 || d.product)) return {product:d.product, source:'OFF he', tried}; }catch(e){ tried.push('OFF he(err)'); }
  // Beauty / Products
  try{ const d=await fetchJSON(API.BEU(barcode)); tried.push('Open Beauty');
       if(d && (d.status===1 || d.product)) return {product:d.product, source:'Open Beauty', tried}; }catch(e){ tried.push('Open Beauty(err)'); }
  try{ const d=await fetchJSON(API.PRD(barcode)); tried.push('Open Products');
       if(d && (d.status===1 || d.product)) return {product:d.product, source:'Open Products', tried}; }catch(e){ tried.push('Open Products(err)'); }
  // Search fallbacks
  const params = { page_size: 30, json: 1 };
  try{ const d=await fetchJSON(API.SEARCH_OFF, {...params, code: barcode}); tried.push('OFF search');
       const p=pickBest(d.products); if(p) return {product:p, source:'OFF search', tried}; }catch(e){ tried.push('OFF search(err)'); }
  try{ const d=await fetchJSON(API.SEARCH_OFF_HE, {...params, code: barcode}); tried.push('OFF he search');
       const p=pickBest(d.products); if(p) return {product:p, source:'OFF he search', tried}; }catch(e){ tried.push('OFF he search(err)'); }
  try{ const d=await fetchJSON(API.SEARCH_BEU, {...params, code: barcode}); tried.push('Beauty search');
       const p=pickBest(d.products); if(p) return {product:p, source:'Beauty search', tried}; }catch(e){ tried.push('Beauty search(err)'); }
  try{ const d=await fetchJSON(API.SEARCH_PRD, {...params, code: barcode}); tried.push('Products search');
       const p=pickBest(d.products); if(p) return {product:p, source:'Products search', tried}; }catch(e){ tried.push('Products search(err)'); }
  return { notFound:true, tried };
}

// ====== SCORING ======
function getFloat(v){ const f=parseFloat(v); return Number.isFinite(f)?f:null; }
function normE(tag){ // "en:e211" -> "E211"
  if(!tag) return null; const s=String(tag).split(':').pop().toUpperCase();
  return s.startsWith('E') ? s : ('E'+s.replace(/[^\d]/g,''));
}
function scoreProduct(p){
  let score = 50, reasons = [];
  const lr = DATA.localRules || { thresholds:{ sugar_high_g_per_100g:10, salt_high_g_per_100g:1.2 } };

  // labels
  const labels = listify(p.labels_tags).concat(listify(p.labels_old)).map(x=>String(x).toLowerCase());
  const positive = new Set((lr.labels_positive||[]).map(x=>String(x).toLowerCase()));
  if(labels.some(x=> Array.from(positive).some(y=> x.includes(y)))){
    score += 6; reasons.push('–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏/—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã');
  }

  // additives (use dictionary if available)
  let additives = listify(p.additives_tags).map(normE).filter(Boolean);
  if(!additives.length && Number.isFinite(p.additives_n)) {
    // —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ ‚Äî –±–µ–∑ —Å–ø–∏—Å–∫–∞
    if(p.additives_n===0){ score+=10; reasons.push('–ë–µ–∑ –¥–æ–±–∞–≤–æ–∫ (E-—á–∏—Å–µ–ª)'); }
  } else if(additives.length){
    const uniq = Array.from(new Set(additives));
    const dict = DATA.additives || {};
    let risky = [];
    uniq.forEach(code=>{
      const meta = dict[code];
      if(meta){
        if((meta.risk||'').includes('–≤—ã—Å–æ–∫')) score -= 5;
        reasons.push(`${code} ‚Äî ${meta.name} (${meta.risk||'–Ω–µ–∏–∑–≤.'})`);
        if((meta.risk||'').includes('–≤—ã—Å–æ–∫')) risky.push(code);
      }
    });
    const n = uniq.length;
    if(n===0){ score+=8; reasons.push('–ë–µ–∑ –¥–æ–±–∞–≤–æ–∫'); }
    else if(n<=2){ score+=2; reasons.push(`–ù–µ–º–Ω–æ–≥–æ –¥–æ–±–∞–≤–æ–∫: ${n}`); }
    else if(n<=5){ score-=6; reasons.push(`–ú–Ω–æ–≥–æ –¥–æ–±–∞–≤–æ–∫: ${n}`); }
    else { score-=12; reasons.push(`–û—á–µ–Ω—å –º–Ω–æ–≥–æ –¥–æ–±–∞–≤–æ–∫: ${n}`); }
    if(risky.length){ reasons.push('–ï—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–∫–∏: '+risky.join(', ')); }
  }

  // allergens
  let allergens = listify(p.allergens_tags).concat(listify(p.traces_tags)).map(a=>String(a).split(':').pop());
  allergens = Array.from(new Set(allergens)).filter(Boolean);
  if(allergens.length){
    const dict = DATA.allergens || {};
    const names = allergens.map(k=> dict[k] || k).slice(0,6);
    score -= 6; reasons.push('–ê–ª–ª–µ—Ä–≥–µ–Ω—ã/—Å–ª–µ–¥—ã: '+names.join(', '));
  }

  // NOVA
  let nova = parseInt(p.nova_group || p.nova_groups);
  if(Number.isFinite(nova)){
    if(nova===1) { score+=10; reasons.push('NOVA 1 ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π'); }
    else if(nova===2){ score+=5; reasons.push('NOVA 2 ‚Äî –±–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞'); }
    else if(nova===3){ score-=5; reasons.push('NOVA 3 ‚Äî –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π'); }
    else if(nova>=4){ score-=12; reasons.push('NOVA 4 ‚Äî —É–ª—å—Ç—Ä–∞–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π'); }
  }

  // nutriments thresholds (use local rules)
  const n = p.nutriments || {};
  const sugar = getFloat(n['sugars_100g']);
  const salt  = getFloat(n['salt_100g']);
  const satfat= getFloat(n['saturated-fat_100g']) ?? getFloat(n['saturated_fat_100g']);
  const t = lr.thresholds||{};
  if(sugar!=null){
    if(sugar <= Math.min(2.5, t.sugar_low_g_per_100g||2.5)){ score+=6; reasons.push(`–ù–∏–∑–∫–∏–π —Å–∞—Ö–∞—Ä: ${sugar} –≥/100–≥`); }
    else if(sugar <= (t.sugar_medium_g_per_100g||5)){ score+=2; reasons.push(`–£–º–µ—Ä–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä: ${sugar} –≥/100–≥`); }
    else if(sugar <= (t.sugar_high_g_per_100g||10)){ score-=4; reasons.push(`–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä: ${sugar} –≥/100–≥`); }
    else { score-=10; reasons.push(`–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π —Å–∞—Ö–∞—Ä: ${sugar} –≥/100–≥`); }
  }
  if(salt!=null){
    if(salt <= (t.salt_low_g_per_100g||0.3)){ score+=4; reasons.push(`–ù–∏–∑–∫–∞—è —Å–æ–ª—å: ${salt} –≥/100–≥`); }
    else if(salt <= (t.salt_medium_g_per_100g||1.2)){ score+=1; reasons.push(`–£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–æ–ª—å: ${salt} –≥/100–≥`); }
    else if(salt <= (t.salt_high_g_per_100g||2)){ score-=4; reasons.push(`–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —Å–æ–ª—å: ${salt} –≥/100–≥`); }
    else { score-=8; reasons.push(`–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è —Å–æ–ª—å: ${salt} –≥/100–≥`); }
  }
  if(satfat!=null){
    if(satfat<=1.5){ score+=3; reasons.push(`–ù–∏–∑–∫–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –∂–∏—Ä—ã: ${satfat} –≥/100–≥`); }
    else if(satfat<=5){ reasons.push(`–£–º–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –∂–∏—Ä—ã: ${satfat} –≥/100–≥`); }
    else { score-=6; reasons.push(`–í—ã—Å–æ–∫–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –∂–∏—Ä—ã: ${satfat} –≥/100–≥`); }
  }

  // ingredients length
  let ingN = p.ingredients_n;
  if(ingN==null && Array.isArray(p.ingredients)) ingN = p.ingredients.length;
  if(Number.isFinite(ingN)){
    if(ingN<=5){ score+=4; reasons.push(`–ö–æ—Ä–æ—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: ${ingN}`); }
    else if(ingN<=10){ reasons.push(`–°—Ä–µ–¥–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: ${ingN}`); }
    else { score-=4; reasons.push(`–î–ª–∏–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: ${ingN}`); }
  }

  score = Math.round(Math.max(0, Math.min(100, score)));
  const light = score>=70 ? 'üü¢ –∑–µ–ª—ë–Ω—ã–π' : (score>=40 ? 'üü° –∂—ë–ª—Ç—ã–π' : 'üî¥ –∫—Ä–∞—Å–Ω—ã–π');
  reasons.unshift(`–°–≤–µ—Ç–æ—Ñ–æ—Ä: ${light}`);
  return { score, reasons, light };
}

function titleOf(p){
  const brand = String(p.brands||'').split(',')[0].trim();
  let name = p.product_name_ru || p.product_name_he || p.product_name || p.generic_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  name = String(name);
  if(brand && !name.toLowerCase().includes(brand.toLowerCase())){
    return `${brand} ‚Äî ${name}`;
  }
  return name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
}
function isIL(p){ const code=String(p.code||''); if(code.startsWith('729')) return true;
  const ct=listify(p.countries_tags).map(x=>String(x).toLowerCase()); return ct.some(c=>c.includes('israel')); }

function renderHead(p, s, source, tried){
  const badge = `<span class="badge ${s.score>=70?'good':(s.score>=40?'warn':'bad')}">${s.light} ‚Ä¢ ${s.score}/100</span>`;
  return `<div class="card">
    <div class="title">${esc(titleOf(p))}</div>
    <div class="code">–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${esc(p.code||'')}</div>
    <div style="margin-top:8px">${badge}</div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <div class="pill">NOVA: ${esc(p.nova_group || p.nova_groups || '‚Äî')}</div>
      <div class="pill">Nutri-Score: ${esc(((p.nutriscore_grade||p.nutrition_grades||'')+'').toUpperCase()||'‚Äî')}</div>
      ${isIL(p)?'<div class="pill">üáÆüá± –ò–∑—Ä–∞–∏–ª—å</div>':''}
      <div class="pill">–ò—Å—Ç–æ—á–Ω–∏–∫: ${esc(source||'-')}</div>
    </div>
    <div style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:6px">–ü—Ä–∏—á–∏–Ω—ã/—Ñ–∞–∫—Ç–æ—Ä—ã:</div>
      <ul>${s.reasons.map(r=>`<li>${esc(r)}`).join('')}</ul>
    </div>
  </div>`;
}

async function searchAlternatives(p, minScore=60){
  const fields = "product_name,product_name_ru,product_name_he,brands,additives_n,additives_tags,allergens_tags,traces_tags,nutriscore_grade,nutrition_grades,nutriments,nova_group,ingredients,ingredients_n,labels_tags,labels_old,code,categories_tags,countries_tags";
  const params = { fields, page_size: 80, sort_by: "unique_scans_n", json: 1, lc: 'he', cc: 'il' };
  const cat = listify(p.categories_tags);
  if(cat.length) params.categories_tags = cat[0];
  else params.search_terms = titleOf(p).split('‚Äî').pop().trim();
  try{
    const d = await fetchJSON(API.SEARCH_OFF, params);
    const scored = (d.products||[]).map(x=>({ p:x, ...scoreProduct(x) }));
    scored.sort((a,b)=> (b.score + (isIL(b.p)?0.6:0)) - (a.score + (isIL(a.p)?0.6:0)));
    const out = []; for(const it of scored){ if(it.score>=minScore && it.p.code!==p.code){ out.push(it); if(out.length>=5) break; } }
    return out;
  }catch(e){ return []; }
}

function renderAlts(title, items){
  if(!items || !items.length) return '';
  return `<div class="card">
    <div class="title">${esc(title)}</div>
    <div class="grid">
      ${items.map(it=> `<div class="alt">
        <div style="display:flex;justify-content:space-between;gap:10px">
          <div style="font-weight:700">${esc(titleOf(it.p))}</div>
          <div class="${it.score>=70?'good':(it.score>=40?'warn':'bad')}">${it.score}/100</div>
        </div>
        <div class="code">–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${esc(it.p.code||'')}</div>
        <div class="note">${isIL(it.p)?'üáÆüá± –ò–∑—Ä–∞–∏–ª—å':''}</div>
      </div>`).join('')}
    </div>
  </div>`;
}

// ====== UI / CAMERA (–º–∏–Ω–∏–º—É–º –ª–æ–≥–∏–∫–∏) ======
let codeReader=null, currentDeviceId=null, soundOn=true;
function setStatus(m){ const s=$('#ovStatus'); if(s) s.textContent=m; }
function beep(){ try{ new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg').play(); }catch(e){} }

async function enumerateCameras(){
  try{ const s=await navigator.mediaDevices.getUserMedia({video:true}); s.getTracks().forEach(t=>t.stop()); }catch(e){}
  const dev=await navigator.mediaDevices.enumerateDevices();
  return dev.filter(d=>d.kind==='videoinput');
}

async function startCamera(){
  $('#camWrap').style.display='flex';
  if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
  const cams = await enumerateCameras();
  const sel = $('#cameraSelect'); sel.innerHTML='';
  cams.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.deviceId; o.textContent=c.label||`–ö–∞–º–µ—Ä–∞ ${i+1}`; sel.appendChild(o); });
  currentDeviceId = cams[0]?.deviceId;
  sel.value = currentDeviceId||'';
  const video = $('#preview');
  setStatus('–ò—â—É —à—Ç—Ä–∏—Ö-–∫–æ–¥‚Ä¶');
  await codeReader.decodeFromConstraints({ video: { deviceId: currentDeviceId ? {exact: currentDeviceId}: undefined, facingMode:'environment' } }, video, (res,err)=>{
    if(res){
      const code = String(res.getText()).trim();
      if(code.length===13 && isValidEAN13(code)){
        $('#barcode').value = code; beep(); stopCamera(); run();
      }
    }
  });
}
function stopCamera(){ try{ codeReader && codeReader.reset(); }catch(e){} const v=$('#preview'); if(v && v.srcObject){ v.srcObject.getTracks().forEach(t=>t.stop()); v.srcObject=null; } $('#stopBtn').disabled=true; }

$('#camBtn').addEventListener('click', startCamera);
$('#stopBtn').addEventListener('click', stopCamera);
$('#soundBtn').addEventListener('click', e=>{ soundOn=!soundOn; e.target.textContent = '–ó–≤—É–∫: '+(soundOn?'–≤–∫–ª':'–≤—ã–∫–ª'); });

// ====== APP ======
const hist=[];
function pushHistory(code){ if(hist.includes(code)) return; hist.unshift(code); if(hist.length>8) hist.pop();
  const box=$('#hist'); box.innerHTML=hist.map(c=>`<span class="chip" data-code="${esc(c)}">${esc(c)}</span>`).join('');
  box.querySelectorAll('.chip').forEach(ch=> ch.addEventListener('click', ()=>{ $('#barcode').value=ch.dataset.code; run(); }));
}

async function run(){
  const bc = $('#barcode').value.trim();
  if(!/^[0-9]{6,}$/.test(bc)){ alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π —à—Ç—Ä–∏—Ö-–∫–æ–¥ (–º–∏–Ω–∏–º—É–º 6 —Ü–∏—Ñ—Ä)'); return; }
  $('#out').innerHTML = '';
  const {product, source, tried, notFound} = await deepFetch(bc);
  if(notFound){
    const seed = DATA.alternativesSeed || {};
    const cat = 'en:table-water'; // –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä, –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const seedCodes = seed[cat]||[];
    let seedHtml = '';
    if(seedCodes.length){
      seedHtml = `<div class="card"><div class="title">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (seed)</div><div class="grid">${
        seedCodes.map(code=> `<div class="alt"><div class="code">–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${esc(code)}</div></div>`).join('')
      }</div></div>`;
    }
    $('#out').innerHTML = `<div class="card">
      <div class="title">–ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –±–∞–∑–∞—Ö</div>
      <div class="note">–ü—Ä–æ–±–æ–≤–∞–ª–∏: ${esc((tried||[]).join(', ')||'-')}.</div>
      <div class="note">–¢–æ–≤–∞—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ–¥–∞–∂–µ –≤ –ò–∑—Ä–∞–∏–ª–µ (–ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∞–π—Å-—Ñ–∏–¥—ã), –Ω–æ —Å–æ—Å—Ç–∞–≤ –µ—â—ë –Ω–µ –≤–Ω–µ—Å—ë–Ω.</div>
    </div>` + seedHtml;
    pushHistory(bc);
    return;
  }
  const s = scoreProduct(product||{});
  const head = renderHead(product, s, source, tried);
  let alts = [];
  try{ alts = await searchAlternatives(product, Math.max(60, s.score)); }catch(e){}
  $('#out').innerHTML = head + renderAlts('–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã', alts) +
    `<div class="note" style="margin-top:10px">–≠—Ç–æ —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞. –î–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π ‚Äî –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º.</div>`;
  pushHistory(bc);
}

// Init
window.addEventListener('DOMContentLoaded', async ()=>{
  await loadData();
  $('#checkBtn').addEventListener('click', run);
  $('#demoBtn').addEventListener('click', ()=>{ $('#barcode').value='5449000000996'; run(); });
  $('#barcode').addEventListener('keydown', (e)=>{ if(e.key==='Enter') run(); });
});
</script>
</body>
</html>
